
#' Title
#'
#' @return
#' @export
#'
#' @examples
tff.data.urls <- function() {
  list(
    "2018" = list(
      "10" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-65-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es//egob/catalogo/202468-22-intensidad-trafico.csv"
      ),
      "9" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-64-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-19-intensidad-trafico.zip"
      ),
      "8" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-63-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-18-intensidad-trafico.zip"
      ),
      "7" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-62-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-17-intensidad-trafico.zip"
      ),
      "6" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-61-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-16-intensidad-trafico.zip"
      ),
      "5" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-60-transporte-ptomedida-historico.zip"),
      "4" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-59-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-14-intensidad-trafico.zip"
      ),
      "3" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-58-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-13-intensidad-trafico.zip"
      ),
      "2" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-57-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-12-intensidad-trafico.zip"
      ),
      "1" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-56-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-11-intensidad-trafico.zip"
      )
    ),
    "2017" = list(
      "12" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-55-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-10-intensidad-trafico.zip"
      ),
      "11" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-54-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-9-intensidad-trafico.zip"
      ),
      "10" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-53-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-4-intensidad-trafico.zip"
      ),
      "9" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-52-transporte-ptomedida-historico.zip"),
      "8" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-51-transporte-ptomedida-historico.zip"),
      "7" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-50-transporte-ptomedida-historico.zip"),
      "6" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-49-transporte-ptomedida-historico.zip"),
      "5" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-48-transporte-ptomedida-historico.zip"),
      "4" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-47-transporte-ptomedida-historico.zip"),
      "3" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-46-transporte-ptomedida-historico.zip",
        metric.sep = ","
      ),
      "2" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-45-transporte-ptomedida-historico.zip"),
      "1" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-44-transporte-ptomedida-historico.zip")
    ),
    "2016" = list(
      "12" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-43-transporte-ptomedida-historico.zip"),
      "11" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-42-transporte-ptomedida-historico.zip"),
      "10" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-41-transporte-ptomedida-historico.zip"),
      "9" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-40-transporte-ptomedida-historico.zip"),
      "8" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-39-transporte-ptomedida-historico.zip"),
      "7" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-38-transporte-ptomedida-historico.zip"),
      "6" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-37-transporte-ptomedida-historico.zip"),
      "5" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-36-transporte-ptomedida-historico.zip"),
      "4" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-35-transporte-ptomedida-historico.zip"),
      "3" = list(
        metric = "https://datos.madrid.es/egob/catalogo/208627-34-transporte-ptomedida-historico.zip",
        device = "https://datos.madrid.es/egob/catalogo/202468-2-intensidad-trafico.zip"
      ),
      "2" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-33-transporte-ptomedida-historico.zip"),
      "1" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-32-transporte-ptomedida-historico.zip")
    ),
    "2015" = list(
      "1" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-18-transporte-ptomedida-historico.zip"),
      "2" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-21-transporte-ptomedida-historico.zip"),
      "3" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-22-transporte-ptomedida-historico.zip"),
      "4" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-23-transporte-ptomedida-historico.zip"),
      "5" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-24-transporte-ptomedida-historico.zip"),
      "6" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-25-transporte-ptomedida-historico.zip"),
      "7" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-26-transporte-ptomedida-historico.zip"),
      "8" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-27-transporte-ptomedida-historico.zip"),
      "9" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-29-transporte-ptomedida-historico.zip"),
      "10" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-28-transporte-ptomedida-historico.zip"),
      "11" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-30-transporte-ptomedida-historico.zip"),
      "12" = list(metric = "https://datos.madrid.es/egob/catalogo/208627-31-transporte-ptomedida-historico.zip")
    )
    # ,'2014' = list(
    #     '1'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-6-transporte-ptomedida-historico.zip",
    #                   device = 'https://datos.madrid.es/egob/catalogo/202468-1-intensidad-trafico.zip'),
    #     '2'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-7-transporte-ptomedida-historico.zip"),
    #     '3'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-8-transporte-ptomedida-historico.zip"),
    #     '4'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-9-transporte-ptomedida-historico.zip"),
    #     '5'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-10-transporte-ptomedida-historico.zip"),
    #     '6'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-11-transporte-ptomedida-historico.zip"),
    #     '7'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-12-transporte-ptomedida-historico.zip"),
    #     '8'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-13-transporte-ptomedida-historico.zip"),
    #     '9'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-14-transporte-ptomedida-historico.zip"),
    #     '10'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-15-transporte-ptomedida-historico.zip"),
    #     '11'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-16-transporte-ptomedida-historico.zip"),
    #     '12'    = list(metric = "https://datos.madrid.es/egob/catalogo/208627-17-transporte-ptomedida-historico.zip"))
  )
}

#' Title
#'
#' @param obj
#'
#' @return
#' @export
#'
#' @examples
tff.encode.obj <- function(obj) {
  tmp <- tempfile()
  saveRDS(obj, file = tmp)
  bin <- readBin(tmp, "raw", file.info(tmp)[1, "size"])
  s <- rawToChar(RCurl::base64Encode(bin, "raw"))
  unlink(tmp)
  s
}

#' Title
#'
#' @param s
#'
#' @return
#' @export
#'
#' @examples
tff.decode.obj <- function(s) {
  tmp <- tempfile()
  writeBin(RCurl::base64Decode(s, "raw"), tmp)
  metric <- readRDS(tmp)
  unlink(tmp)
  metric
}

#' Title
#'
#' @param y
#' @param m
#' @param t
#' @param ...
#'
#' @return
#' @export
#'
#' @examples
tff.download.data <- function(y, m, t = c("metric", "device"), ...) {
  cat("downloading data ...\n")
  tff.url <- tff.data.urls()[[as.character(y)]][[as.character(m)]][[t]]
  tff.sep <- tff.data.urls()[[as.character(y)]][[as.character(m)]][["metric.sep"]]
  sep <- ifelse(is.null(sep), ";", sep)

  temp <- tempfile()
  utils::download.file(url, temp, mode = "wb")
  files <- utils::unzip(temp, list = TRUE)$Name
  data <-
      utils::read.csv(
      unz(temp, files[which(endsWith(files, ".csv"))]),
      header = T,
      quote = "\"",
      stringsAsFactors = F,
      sep = sep,
      dec = ".",
      encoding = "latin1",
      ...
    )
  unlink(temp)
  data
}

#' Title
#'
#' @param df
#'
#' @return
#' @export
#'
#' @examples
tff.parse.raw.metric <- function(df) {
  if ("fecha" %in% colnames(df)) {
    df$fecha <- lubridate::ymd_hms(df$fecha)
  }
  if ("idelem" %in% colnames(df)) {
    df$id <- df$idelem
    df$idelem <- NULL
  }
  if ("identif" %in% colnames(df)) {
    df$identif <- NULL
  }
  if ("tipo_elem" %in% colnames(df)) {
    if (is.character(df$tipo_elem)) {
      df$tipo_elem[df$tipo_elem == "PUNTOS MEDIDA M-30"] <- "M30"
      df$tipo_elem[df$tipo_elem == "PUNTOS MEDIDA URBANOS"] <- "URB"
    }
    if (is.numeric(df$tipo_elem)) {
      df$tipo_elem[df$tipo_elem == 494] <- "M30"
      df$tipo_elem[df$tipo_elem == 495] <- "URB"
    }
  }
  if ("tipo" %in% colnames(df)) {
    df$tipo <- NULL
  }
  df[, c("id", "fecha", "tipo_elem", "intensidad", "ocupacion", "carga", "vmed", "error", "periodo_integracion")]
}

#' Title
#'
#' @param df
#'
#' @return
#' @export
#'
#' @examples
tff.parse.raw.location <- function(df) {
  if ("tipo_elem" %in% colnames(df)) {
    if (is.character(df$tipo_elem)) {
      df$tipo_elem[df$tipo_elem == "PUNTOS DE MEDIDA M-30"] <- "M30"
      df$tipo_elem[df$tipo_elem == "M-30"] <- "M30"
      df$tipo_elem[df$tipo_elem == "URBANOS"] <- "URB"
    }
  }
  if ("st_x" %in% colnames(df)) {
    df$x <- df$st_x
  }
  if ("utm_x" %in% colnames(df)) {
    df$x <- df$utm_x
  }
  if ("x" %in% colnames(df)) {
    df$x <- as.double(sub(",", ".", df$x, fixed = TRUE))
  }
  if ("st_y" %in% colnames(df)) {
    df$y <- df$st_y
  }
  if ("utm_y" %in% colnames(df)) {
    df$y <- df$utm_y
  }
  if ("y" %in% colnames(df)) {
    df$y <- as.double(sub(",", ".", df$y, fixed = TRUE))
  }
  df[, c("tipo_elem", "id", "cod_cent", "nombre", "x", "y")]
}
